{%- from "drbd9/map.jinja" import drbd9 with context %}
# Managed by salt - do not edit
resource {{resource}} {
  net {
    cram-hmac-alg       {{ resource_data.get('net_options', {}).get('cram_hmac_alg', 'sha256') }}; #FIXME sha1 makes drbd faster?
    shared-secret       "{{ resource_data.get('net_options', {}).get('shared_secret', 'hoonetorg') }}"; 
    allow-two-primaries {{ resource_data.get('net_options', {}).get('allow_two_primaries', 'no') }};
  }
  {%- for node, node_data in resource_data.get('nodes', {}).items()|sort %}
  on {{ node }} {
    node-id     {{ node_data.get('id') }};
    address     ipv4 {{ node_data.get('ipv4') }}:{{ resource_data.get('port') }};
    {%- for volume, volume_data in resource_data.volumes.items()|sort %}
      {%- if node_data.get('diskless', False) %}
        {%- set disk = 'none' %}
      {%- elif drbd9.resource_type in [ 'zvol' ] %}
        {%- set disk =  '/dev/zvol/' + drbd9.resource_pool + '/' + resource + '_' + volume  %}
      {%- else %}
        {%- set disk = None %}
      {%- endif %}
      {%- if volume_data.get('meta_disk', False) %}
        {%- if drbd9.resource_type_meta in [ 'lvm' ] %}
          {%- set meta_disk = '/dev/' + drbd9.resource_pool_meta + '/' + resource + '_' + volume + '_meta' %}
        {%- else %}
          {%- set meta_disk = None %}
        {%- endif %}
      {%- endif %}
    volume {{ volume }} {
      device      minor {{ volume_data.get('minor') }};
      disk        {{ disk }};
      {%- if not node_data.get('diskless', False) %}
      meta-disk   {{ meta_disk|default('internal') }};
      {%- endif %}
    }
    {%- endfor %}
  }
  {%- endfor %}
  connection-mesh {
    hosts {{ resource_data.get('nodes', {}).keys()|join(' ') }};
    net {
      protocol {{ resource_data.get('net_options', {}).get('protocol', 'C') }};
    }
  }
}
